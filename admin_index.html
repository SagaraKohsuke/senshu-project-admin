<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>朝夕食予約システム - 管理画面</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <style>
    /* Android font scaling fix */
    *, *::before, *::after {
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }
    
    body { 
      font-family: 'Helvetica Neue', Arial, sans-serif; 
      margin: 0; 
      padding: 10px; 
      background-color: #f5f5f5;
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background-color: white; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }
    h1 { color: #333; margin-top: 0; font-size: 1.5rem; }
    h2.month-header { color: #2c3e50; text-align: center; margin: 20px 0 15px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select, input { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      background-color: white; 
      font-size: 16px !important; 
      box-sizing: border-box;
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }
    .loading { display: flex; justify-content: center; padding: 20px; color: #666; }
    
    /* カレンダースタイル - スマホ最適化 */
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 20px; }
    .weekday-header { text-align: center; font-weight: bold; padding: 8px 4px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9rem; }
    .calendar-cell { min-height: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; background-color: white; overflow: hidden; cursor: pointer; transition: all 0.2s ease; }
    .calendar-cell:hover { background-color: #f8f9fa; }
    .calendar-cell.today { background-color: #fff8e1; border-color: #ffca28; }
    .calendar-cell.selected { background-color: #e3f2fd; border-color: #2196f3; border-width: 2px; }
    .empty-cell { background-color: #f9f9f9; cursor: default; }
    .empty-cell:hover { background-color: #f9f9f9; }
    .date-header { font-weight: bold; text-align: right; border-bottom: 1px solid #eee; padding-bottom: 3px; margin-bottom: 5px; font-size: 0.9rem; }
    .meal-section { font-size: 0.75rem; }
    .meal-item { margin-bottom: 4px; }
    .meal-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .meal-count { display: inline-block; background-color: #4285f4; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; }
    .menu-display { font-size: 0.7rem !important; color: #555; padding-left: 3px; margin-bottom: 3px; line-height: 1.1; }
    .recruitment-control { margin-top: 4px; text-align: center; }
    .stop-button { padding: 3px 6px; font-size: 0.65rem; border: none; border-radius: 3px; cursor: pointer; background-color: #dc3545; color: white; }
    .stop-button:hover { background-color: #c82333; }
    .stop-button.stopped { background-color: #28a745; }
    .stop-button.stopped:hover { background-color: #218838; }
    .unavailable { font-size: 0.7rem; color: #999; }
    hr { margin: 6px 0; border: none; border-top: 1px dotted #ddd; }
    
    /* メニュー編集エリア */
    .menu-edit-area { 
      background-color: #f8f9fa; 
      border: 1px solid #dee2e6; 
      border-radius: 8px; 
      padding: 20px; 
      margin-bottom: 20px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .menu-edit-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 15px; 
      border-bottom: 2px solid #dee2e6; 
      padding-bottom: 10px; 
    }
    .menu-edit-date { 
      font-size: 1.2rem; 
      font-weight: bold; 
      color: #2c3e50; 
    }
    .menu-edit-close { 
      background: none; 
      border: none; 
      font-size: 1.5rem; 
      cursor: pointer; 
      color: #6c757d; 
      padding: 5px; 
    }
    .menu-edit-close:hover { color: #dc3545; }
    .meal-edit-section { 
      margin-bottom: 20px; 
      padding: 15px; 
      background-color: white; 
      border-radius: 6px; 
      border-left: 4px solid #4285f4; 
    }
    .meal-edit-section.dinner { border-left-color: #e74c3c; }
    .meal-edit-title { 
      font-size: 1.1rem; 
      font-weight: bold; 
      margin-bottom: 10px; 
      color: #2c3e50; 
    }
    .current-menu { 
      margin-bottom: 15px; 
      padding: 10px; 
      background-color: #e9ecef; 
      border-radius: 4px; 
    }
    .current-menu-label { 
      font-weight: bold; 
      margin-bottom: 5px; 
      color: #495057; 
    }
    .current-menu-text { 
      color: #6c757d; 
      font-style: italic; 
    }
    .menu-input-section { 
      display: flex; 
      gap: 10px; 
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .autocomplete-container {
      position: relative;
      flex: 2;
      min-width: 200px;
    }
    .calorie-input-container {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
    }
    .calorie-input-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }
    .calorie-input-container input {
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      width: 70px;
    }
    .calorie-input-container .calorie-unit {
      display: inline-block;
      margin-left: 5px;
      color: #6c757d;
      font-size: 14px;
      line-height: 36px;
    }
    .menu-calorie {
      color: #6c757d;
      font-size: 0.9em;
    }
    .calorie-info {
      font-size: 0.8em;
      color: #6c757d;
      margin-top: 2px;
    }
    .current-calorie {
      color: #6c757d;
      font-size: 0.9em;
    }
    .autocomplete-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ced4da;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .autocomplete-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.selected {
      background-color: #e9ecef;
    }
    .autocomplete-suggestion:last-child {
      border-bottom: none;
    }
    .autocomplete-container label { 
      display: block; 
      margin-bottom: 5px; 
      font-weight: bold; 
      color: #495057; 
    }
    .autocomplete-container input { 
      width: 100%; 
      padding: 8px 12px; 
      border: 1px solid #ced4da; 
      border-radius: 4px; 
      font-size: 14px; 
    }
    .menu-update-btn { 
      background-color: #28a745; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      padding: 8px 20px; 
      font-size: 14px; 
      cursor: pointer; 
      white-space: nowrap; 
      height: fit-content; 
    }
    .menu-update-btn:hover { background-color: #218838; }
    .menu-update-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
    .recruitment-toggle-section { 
      text-align: center; 
      padding-top: 10px; 
      border-top: 1px solid #dee2e6; 
      margin-top: 10px; 
    }
    .recruitment-toggle-btn { 
      padding: 8px 16px; 
      font-size: 14px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      background-color: #dc3545; 
      color: white; 
    }
    .recruitment-toggle-btn:hover { background-color: #c82333; }
    .recruitment-toggle-btn.stopped { background-color: #28a745; }
    .recruitment-toggle-btn.stopped:hover { background-color: #218838; }
    .meal-unavailable { 
      text-align: center; 
      color: #6c757d; 
      font-style: italic; 
      padding: 20px; 
    }
    
    /* ナビゲーション - スマホ対応 */
    .month-navigation { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 20px; flex-wrap: wrap; gap: 10px; }
    .month-navigation button { 
      background-color: #4285f4; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      padding: 10px 15px; 
      cursor: pointer; 
      font-size: 14px !important; 
      min-width: 120px;
      -webkit-text-size-adjust: 100% !important;
      -moz-text-size-adjust: 100% !important;
      -ms-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }
    .month-navigation button:disabled { background-color: #b0bec5; cursor: not-allowed; }
    .month-navigation h3 { margin: 0 10px; font-size: 1.1rem; }
    
    /* ヘッダー - スマホ対応 */
    .calendar-container { margin-top: 20px; }
    .admin-header { background-color: #2c3e50; color: white; padding: 15px; margin: -15px -15px 20px -15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .admin-header h1 { color: white; margin: 0; }
    .admin-badge { background-color: #e74c3c; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
    
    /* サマリーセクション - スマホ対応 */
    .summary-section { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .summary-title { font-weight: bold; margin-bottom: 15px; text-align: center; font-size: 1.1rem; }
    .reservation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .reservation-card { background-color: white; padding: 12px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .reservation-card-header { font-weight: bold; margin-bottom: 8px; text-align: center; padding: 8px; border-radius: 3px; color: white; font-size: 0.9rem; }
    .reservation-card-header.today-breakfast { background-color: #f39c12; }
    .reservation-card-header.today-dinner { background-color: #e74c3c; }
    .reservation-card-header.tomorrow-breakfast { background-color: #3498db; }
    .reservation-card-header.tomorrow-dinner { background-color: #9b59b6; }
    .reservation-count { font-size: 1.3rem; font-weight: bold; text-align: center; margin: 10px 0; }
    .reservation-users { overflow-y: visible; max-height: none; }
    .reservation-users p { margin: 3px 0; font-size: 0.8rem; padding: 3px 6px; background-color: #f8f9fa; border-radius: 3px; }
    .no-reservations { text-align: center; color: #7f8c8d; font-style: italic; padding: 12px; font-size: 0.9rem; }
    .total-count { background-color: #3498db; color: white; padding: 2px 8px; border-radius: 3px; }
    
    /* タブレット対応 */
    @media (max-width: 1024px) {
      .container { padding: 12px; }
      .calendar { gap: 1px; }
      .calendar-cell { min-height: 90px; padding: 3px; }
      .meal-section { font-size: 0.7rem; }
      .menu-edit-area { padding: 15px; }
      .meal-edit-section { padding: 12px; }
    }
    
    /* スマートフォン対応 */
    @media (max-width: 768px) {
      body { padding: 5px; }
      .container { padding: 10px; }
      .admin-header { padding: 12px; margin: -10px -10px 15px -10px; }
      .admin-header h1 { font-size: 1.2rem; }
      .reservation-grid { grid-template-columns: 1fr; gap: 8px; }
      .month-navigation { flex-direction: column; gap: 8px; }
      .month-navigation button { min-width: 100px; padding: 8px 12px; }
      .calendar { grid-template-columns: repeat(7, 1fr); gap: 1px; }
      .calendar-cell { min-height: 80px; padding: 2px; }
      .weekday-header { padding: 6px 2px; font-size: 0.8rem; }
      .date-header { font-size: 0.8rem; }
      .meal-section { font-size: 0.65rem; }
      .meal-count { font-size: 0.6rem; padding: 1px 4px; }
      .menu-display { font-size: 0.6rem !important; }
      .summary-title { font-size: 1rem; }
      .reservation-count { font-size: 1.1rem; }
      .reservation-users p { font-size: 0.75rem; }
      .menu-edit-area { padding: 12px; }
      .menu-edit-date { font-size: 1rem; }
      .meal-edit-section { padding: 10px; }
      .meal-edit-title { font-size: 1rem; }
    }
    
    /* 小さなスマートフォン対応 */
    @media (max-width: 480px) {
      body { padding: 2px; }
      .container { padding: 8px; }
      .admin-header { padding: 10px; margin: -8px -8px 12px -8px; }
      .admin-header h1 { font-size: 1.1rem; }
      .month-navigation h3 { font-size: 1rem; }
      .calendar-cell { min-height: 70px; padding: 1px; }
      .weekday-header { padding: 4px 1px; font-size: 0.7rem; }
      .date-header { font-size: 0.7rem; }
      .meal-section { font-size: 0.6rem; }
      .meal-count { font-size: 0.55rem; }
      .menu-display { font-size: 0.55rem !important; }
      .reservation-users p { font-size: 0.7rem; padding: 2px 4px; }
      .menu-edit-area { padding: 10px; }
      .menu-edit-date { font-size: 0.9rem; }
      .meal-edit-section { padding: 8px; }
      .meal-edit-title { font-size: 0.9rem; }
      .menu-input-section { flex-direction: column; gap: 8px; }
    }
    
    /* 横向きスマートフォン対応 */
    @media (max-width: 768px) and (orientation: landscape) {
      .reservation-grid { grid-template-columns: repeat(2, 1fr); }
      .month-navigation { flex-direction: row; }
      .calendar-cell { min-height: 80px; }
    }
    
    /* タッチデバイス用のボタン調整 */
    @media (pointer: coarse) {
      .menu-update-btn, .recruitment-toggle-btn { min-height: 40px; min-width: 80px; }
      select, input { min-height: 40px; }
      .month-navigation button { min-height: 40px; }
      .calendar-cell { min-height: 90px; }
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="admin-header">
      <h1>朝夕食予約システム</h1>
      <span class="admin-badge">管理者画面</span>
    </div>

    <div class="form-group" v-if="loading">
      <div class="loading">読み込み中...</div>
    </div>

    <div v-else>
      <div class="month-navigation">
        <button @click="prevMonth" :disabled="calendarLoading || menuUpdateLoading || recruitmentToggleLoading">&laquo; 前月</button>
        <h3>{{ currentYear }}年 {{ currentMonth }}月</h3>
        <button @click="nextMonth" :disabled="calendarLoading || menuUpdateLoading || recruitmentToggleLoading">次月 &raquo;</button>
        <button @click="openMealSheet" :disabled="sheetOpenLoading || calendarLoading">
          <span v-if="sheetOpenLoading">処理中...</span>
          <span v-else>食事原紙を確認</span>
        </button>
      </div>

      <div class="summary-section" v-if="isCurrentMonth">
        <div class="summary-title">
          {{ reservationStatusTitle }}
        </div>
        <div class="reservation-grid">
          <!-- 今日の朝食 -->
          <div class="reservation-card">
            <div class="reservation-card-header today-breakfast">
              {{ todayDateJapanese }}朝食
            </div>
            <div class="reservation-count">
              {{ todayBreakfastCount }}食
            </div>
            <div v-if="todayBreakfastCount > 0" class="reservation-users">
              <p v-for="(user, idx) in todayBreakfastUsers" :key="'today-b-' + idx">
                {{ user.userId }}号室 - {{ user.userName }}
              </p>
            </div>
            <div v-else class="no-reservations">
              予約なし
            </div>
          </div>

          <!-- 今日の夕食 -->
          <div class="reservation-card">
            <div class="reservation-card-header today-dinner">
              {{ todayDateJapanese }}夕食
            </div>
            <div class="reservation-count">
              {{ todayDinnerCount }}食
            </div>
            <div v-if="todayDinnerCount > 0" class="reservation-users">
              <p v-for="(user, idx) in todayDinnerUsers" :key="'today-d-' + idx">
                {{ user.userId }}号室 - {{ user.userName }}
              </p>
            </div>
            <div v-else class="no-reservations">
              予約なし
            </div>
          </div>

          <!-- 明日の朝食 -->
          <div class="reservation-card">
            <div class="reservation-card-header tomorrow-breakfast">
              {{ tomorrowDateJapanese }}朝食
            </div>
            <div class="reservation-count">
              {{ tomorrowBreakfastCount }}食
            </div>
            <div v-if="tomorrowBreakfastCount > 0" class="reservation-users">
              <p v-for="(user, idx) in tomorrowBreakfastUsers" :key="'tomorrow-b-' + idx">
                {{ user.userId }}号室 - {{ user.userName }}
              </p>
            </div>
            <div v-else class="no-reservations">
              予約なし
            </div>
          </div>

          <!-- 明日の夕食 -->
          <div class="reservation-card">
            <div class="reservation-card-header tomorrow-dinner">
              {{ tomorrowDateJapanese }}夕食
            </div>
            <div v-if="!isTomorrowSaturday" class="reservation-count">
              {{ tomorrowDinnerCount }}食
            </div>
            <div v-if="!isTomorrowSaturday && tomorrowDinnerCount > 0" class="reservation-users">
              <p v-for="(user, idx) in tomorrowDinnerUsers" :key="'tomorrow-d-' + idx">
                {{ user.userId }}号室 - {{ user.userName }}
              </p>
            </div>
            <div v-if="!isTomorrowSaturday && tomorrowDinnerCount === 0" class="no-reservations">
              予約なし
            </div>
            <div v-if="isTomorrowSaturday" class="no-reservations">
              土曜日のため提供なし
            </div>
          </div>
        </div>
      </div>

      <!-- メニュー編集エリア -->
      <div v-if="selectedDate" class="menu-edit-area">
        <div class="menu-edit-header">
          <div class="menu-edit-date">{{ formatDateJapanese(new Date(selectedDate)) }} のメニュー編集</div>
          <button class="menu-edit-close" @click="closeMenuEdit">&times;</button>
        </div>
        
        <!-- 朝食編集セクション -->
        <div v-if="getBreakfastForDate(selectedDate)" class="meal-edit-section">
          <div class="meal-edit-title">🌅 朝食 ({{ getBreakfastForDate(selectedDate).count }}食)</div>
          
          <div v-if="!isRecruitmentStopped(selectedDate, 'breakfast')">
            <div class="current-menu">
              <div class="current-menu-label">現在のメニュー:</div>
              <div class="current-menu-text">
                {{ getBreakfastForDate(selectedDate).menuName || '未設定' }}
                <span v-if="getBreakfastForDate(selectedDate).menuName && getBreakfastForDate(selectedDate).menuName !== '未設定' && getBreakfastForDate(selectedDate).calorie" class="current-calorie">
                  ({{ getBreakfastForDate(selectedDate).calorie }}kcal)
                </span>
              </div>
            </div>
            
            <div class="menu-input-section">
              <div class="autocomplete-container">
                <label>メニューを入力:</label>
                <input type="text" 
                       v-model="editBreakfastMenu" 
                       @input="onBreakfastMenuInput"
                       @keydown="onBreakfastKeydown"
                       @blur="hideBreakfastSuggestions"
                       @focus="showBreakfastSuggestions"
                       placeholder="メニューを入力してください（頭文字で予測表示）"
                       autocomplete="off">
                <div v-if="showBreakfastSuggestionsList && filteredBreakfastMenus.length > 0" 
                     class="autocomplete-suggestions">
                  <div v-for="(menu, index) in filteredBreakfastMenus" 
                       :key="menu.name" 
                       class="autocomplete-suggestion"
                       :class="{ selected: breakfastSelectedIndex === index }"
                       @mousedown="selectBreakfastMenu(menu)"
                       @mouseenter="breakfastSelectedIndex = index">
                    {{ menu.name }} <span class="menu-calorie">({{ menu.calorie }}kcal)</span>
                  </div>
                </div>
              </div>
              <div class="calorie-input-container">
                <label>カロリー:</label>
                <input type="number" 
                       v-model.number="editBreakfastCalorie"
                       placeholder="0"
                       min="0"
                       max="9999">
                <span class="calorie-unit">kcal</span>
              </div>
              <button class="menu-update-btn" @click="updateSelectedMenu('breakfast')" :disabled="menuUpdateLoading">
                <span v-if="menuUpdateLoading">更新中...</span>
                <span v-else>メニュー更新</span>
              </button>
            </div>
          </div>
          <div v-else class="meal-unavailable">この日の朝食は休止中です</div>
          
          <div class="recruitment-toggle-section">
            <button class="recruitment-toggle-btn" 
                    :class="{ 'stopped': isRecruitmentStopped(selectedDate, 'breakfast') }"
                    @click="toggleSelectedRecruitmentStop('breakfast')" 
                    :disabled="recruitmentToggleLoading">
              <span v-if="recruitmentToggleLoading">処理中...</span>
              <span v-else>{{ isRecruitmentStopped(selectedDate, 'breakfast') ? '朝食の休止を解除する' : '朝食を休止する' }}</span>
            </button>
          </div>
        </div>
        <div v-else class="meal-edit-section">
          <div class="meal-unavailable">この日は朝食の提供がありません</div>
        </div>

        <!-- 夕食編集セクション -->
        <div v-if="getDinnerForDate(selectedDate) && !isSaturday(selectedDate)" class="meal-edit-section dinner">
          <div class="meal-edit-title">🌆 夕食 ({{ getDinnerForDate(selectedDate).count }}食)</div>
          
          <div v-if="!isRecruitmentStopped(selectedDate, 'dinner')">
            <div class="current-menu">
              <div class="current-menu-label">現在のメニュー:</div>
              <div class="current-menu-text">
                {{ getDinnerForDate(selectedDate).menuName || '未設定' }}
                <span v-if="getDinnerForDate(selectedDate).menuName && getDinnerForDate(selectedDate).menuName !== '未設定' && getDinnerForDate(selectedDate).calorie" class="current-calorie">
                  ({{ getDinnerForDate(selectedDate).calorie }}kcal)
                </span>
              </div>
            </div>
            
            <div class="menu-input-section">
              <div class="autocomplete-container">
                <label>メニューを入力:</label>
                <input type="text" 
                       v-model="editDinnerMenu" 
                       @input="onDinnerMenuInput"
                       @keydown="onDinnerKeydown"
                       @blur="hideDinnerSuggestions"
                       @focus="showDinnerSuggestions"
                       placeholder="メニューを入力してください（頭文字で予測表示）"
                       autocomplete="off">
                <div v-if="showDinnerSuggestionsList && filteredDinnerMenus.length > 0" 
                     class="autocomplete-suggestions">
                  <div v-for="(menu, index) in filteredDinnerMenus" 
                       :key="menu.name" 
                       class="autocomplete-suggestion"
                       :class="{ selected: dinnerSelectedIndex === index }"
                       @mousedown="selectDinnerMenu(menu)"
                       @mouseenter="dinnerSelectedIndex = index">
                    {{ menu.name }} <span class="menu-calorie">({{ menu.calorie }}kcal)</span>
                  </div>
                </div>
              </div>
              <div class="calorie-input-container">
                <label>カロリー:</label>
                <input type="number" 
                       v-model.number="editDinnerCalorie"
                       placeholder="0"
                       min="0"
                       max="9999">
                <span class="calorie-unit">kcal</span>
              </div>
              <button class="menu-update-btn" @click="updateSelectedMenu('dinner')" :disabled="menuUpdateLoading">
                <span v-if="menuUpdateLoading">更新中...</span>
                <span v-else>メニュー更新</span>
              </button>
            </div>
          </div>
          <div v-else class="meal-unavailable">この日の夕食は休止中です</div>
          
          <div class="recruitment-toggle-section">
            <button class="recruitment-toggle-btn" 
                    :class="{ 'stopped': isRecruitmentStopped(selectedDate, 'dinner') }"
                    @click="toggleSelectedRecruitmentStop('dinner')" 
                    :disabled="recruitmentToggleLoading">
              <span v-if="recruitmentToggleLoading">処理中...</span>
              <span v-else>{{ isRecruitmentStopped(selectedDate, 'dinner') ? '夕食の休止を解除する' : '夕食を休止する' }}</span>
            </button>
          </div>
        </div>
        <div v-else-if="isSaturday(selectedDate)" class="meal-edit-section dinner">
          <div class="meal-unavailable">土曜日は夕食の提供がありません</div>
        </div>
        <div v-else class="meal-edit-section dinner">
          <div class="meal-unavailable">この日は夕食の提供がありません</div>
        </div>
      </div>

      <div class="calendar-container" v-if="calendarLoaded">
        <div class="calendar">
          <div v-for="(day, index) in weekdays" :key="index" class="weekday-header">{{ day }}</div>
        </div>
        <div class="calendar" style="margin-top: 1px;">
          <div v-for="i in offset" :key="'empty-' + i" class="calendar-cell empty-cell"></div>
          <div v-for="date in monthDates" :key="date" 
               class="calendar-cell" 
               :class="{ 'today': isToday(date), 'selected': selectedDate === date }"
               @click="selectDate(date)">
            <div class="date-header">{{ getDayFromDate(date) }}</div>
            <div class="meal-section">
              <div v-if="getBreakfastForDate(date)" class="meal-item">
                <div class="meal-title">
                  <strong>朝食</strong>
                  <span class="meal-count">{{ getBreakfastForDate(date).count }}食</span>
                </div>
                <div class="menu-display" v-if="!isRecruitmentStopped(date, 'breakfast')">
                  {{ getBreakfastForDate(date).menuName || '未設定' }}
                  <div v-if="getBreakfastForDate(date).menuName && getBreakfastForDate(date).menuName !== '未設定' && getBreakfastForDate(date).calorie" class="calorie-info">
                    ({{ getBreakfastForDate(date).calorie }}kcal)
                  </div>
                </div>
                <div v-if="isRecruitmentStopped(date, 'breakfast')" class="meal-unavailable">休止中</div>
              </div>
              <div v-else class="meal-item">
                <div class="meal-title">
                  <strong>朝食</strong>
                  <span class="unavailable">✗</span>
                </div>
              </div>

              <hr />

              <div v-if="getDinnerForDate(date) && !isSaturday(date)" class="meal-item">
                <div class="meal-title">
                  <strong>夕食</strong>
                  <span class="meal-count">{{ getDinnerForDate(date).count }}食</span>
                </div>
                <div class="menu-display" v-if="!isRecruitmentStopped(date, 'dinner')">
                  {{ getDinnerForDate(date).menuName || '未設定' }}
                  <div v-if="getDinnerForDate(date).menuName && getDinnerForDate(date).menuName !== '未設定' && getDinnerForDate(date).calorie" class="calorie-info">
                    ({{ getDinnerForDate(date).calorie }}kcal)
                  </div>
                </div>
                <div v-if="isRecruitmentStopped(date, 'dinner')" class="meal-unavailable">休止中</div>
              </div>
              <div v-else-if="isSaturday(date)" class="meal-item">
                <div class="meal-title">
                  <strong>夕食</strong>
                  <span class="unavailable">✗</span>
                </div>
              </div>
              <div v-else class="meal-item">
                <div class="meal-title">
                  <strong>夕食</strong>
                  <span class="unavailable">✗</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else-if="calendarLoading" class="loading">
        カレンダーデータを読み込み中...
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        loading: true,
        currentYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth() + 1,
        calendarLoading: false,
        calendarLoaded: false,
        weekdays: ['日', '月', '火', '水', '木', '金', '土'],
        offset: 0,
        monthDates: [],
        breakfastReservations: [],
        dinnerReservations: [],
        breakfastMenuInputs: {},
        dinnerMenuInputs: {},
        breakfastMenuList: [],
        dinnerMenuList: [],
        recruitmentStops: {}, // 募集停止情報を格納
        menuUpdateLoading: false, // メニュー更新中のローディング
        recruitmentToggleLoading: false, // 募集停止切り替え中のローディング
        sheetOpenLoading: false, // スプレッドシート開く処理中のローディング
        selectedDate: null, // 選択された日付
        editBreakfastMenu: '', // 編集中の朝食メニュー
        editDinnerMenu: '', // 編集中の夕食メニュー
        editBreakfastCalorie: 0, // 編集中の朝食カロリー
        editDinnerCalorie: 0, // 編集中の夕食カロリー
        // Autocomplete functionality
        showBreakfastSuggestionsList: false, // 朝食の予測候補リスト表示フラグ
        showDinnerSuggestionsList: false, // 夕食の予測候補リスト表示フラグ
        filteredBreakfastMenus: [], // フィルタされた朝食メニューリスト
        filteredDinnerMenus: [], // フィルタされた夕食メニューリスト
        breakfastSelectedIndex: -1, // 朝食の選択中インデックス
        dinnerSelectedIndex: -1 // 夕食の選択中インデックス
      },
      computed: {
        isCurrentMonth: function() {
          const now = new Date();
          return this.currentYear === now.getFullYear() && this.currentMonth === now.getMonth() + 1;
        },
        todayBreakfastCount: function() {
          if (!this.isCurrentMonth) return 0;
          const today = new Date();
          const todayStr = this.formatDate(today);
          const breakfast = this.getBreakfastForDate(todayStr);
          return breakfast ? breakfast.count : 0;
        },
        todayDinnerCount: function() {
          if (!this.isCurrentMonth) return 0;
          const today = new Date();
          const todayStr = this.formatDate(today);
          const dinner = this.getDinnerForDate(todayStr);
          return dinner ? dinner.count : 0;
        },
        todayBreakfastUsers: function() {
          if (!this.isCurrentMonth) return [];
          const today = new Date();
          const todayStr = this.formatDate(today);
          const breakfast = this.getBreakfastForDate(todayStr);
          return breakfast ? breakfast.users : [];
        },
        todayDinnerUsers: function() {
          if (!this.isCurrentMonth) return [];
          const today = new Date();
          const todayStr = this.formatDate(today);
          const dinner = this.getDinnerForDate(todayStr);
          return dinner ? dinner.users : [];
        },
        // 明日の予約データ
        tomorrowBreakfastCount: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = this.formatDate(tomorrow);
          
          // 明日が翌月の場合の処理
          if (tomorrow.getMonth() + 1 !== this.currentMonth || tomorrow.getFullYear() !== this.currentYear) {
            return 0;
          }
          
          const breakfast = this.getBreakfastForDate(tomorrowStr);
          return breakfast ? breakfast.count : 0;
        },
        tomorrowDinnerCount: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = this.formatDate(tomorrow);
          
          // 明日が翌月の場合の処理
          if (tomorrow.getMonth() + 1 !== this.currentMonth || tomorrow.getFullYear() !== this.currentYear) {
            return 0;
          }
          
          const dinner = this.getDinnerForDate(tomorrowStr);
          return dinner ? dinner.count : 0;
        },
        tomorrowBreakfastUsers: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = this.formatDate(tomorrow);
          
          // 明日が翌月の場合の処理
          if (tomorrow.getMonth() + 1 !== this.currentMonth || tomorrow.getFullYear() !== this.currentYear) {
            return [];
          }
          
          const breakfast = this.getBreakfastForDate(tomorrowStr);
          return breakfast ? breakfast.users : [];
        },
        tomorrowDinnerUsers: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          const tomorrowStr = this.formatDate(tomorrow);
          
          // 明日が翌月の場合の処理
          if (tomorrow.getMonth() + 1 !== this.currentMonth || tomorrow.getFullYear() !== this.currentYear) {
            return [];
          }
          
          const dinner = this.getDinnerForDate(tomorrowStr);
          return dinner ? dinner.users : [];
        },
        // 明日が土曜日かどうか
        isTomorrowSaturday: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          return tomorrow.getDay() === 6;
        },
        // 今日の日付（日本語表示）
        todayDateJapanese: function() {
          const today = new Date();
          return this.formatDateJapanese(today);
        },
        // 明日の日付（日本語表示）
        tomorrowDateJapanese: function() {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          return this.formatDateJapanese(tomorrow);
        },
        // セクションタイトル用の日付範囲
        reservationStatusTitle: function() {
          return `${this.todayDateJapanese}・${this.tomorrowDateJapanese}の予約状況`;
        }
      },
      methods: {
        loadCalendarData: function() {
          this.calendarLoading = true;
          this.calendarLoaded = false;
          this.fetchMenuLists();
          this.fetchRecruitmentStops();
          google.script.run
            .withSuccessHandler(this.processCalendarData)
            .withFailureHandler(this.handleCalendarError)
            .getMonthlyReservationCounts(this.currentYear, this.currentMonth);
        },
        fetchRecruitmentStops: function() {
          google.script.run
            .withSuccessHandler(response => {
              if (response.success) {
                this.recruitmentStops = response.stops;
              }
            })
            .withFailureHandler(this.handleError)
            .getRecruitmentStops(this.currentYear, this.currentMonth);
        },
        fetchMenuLists: function() {
          google.script.run
            .withSuccessHandler(this.processMenuLists)
            .withFailureHandler(this.handleError)
            .getMenuLists();
        },
        processMenuLists: function(data) {
          if (data.success) {
            this.breakfastMenuList = data.breakfast;
            this.dinnerMenuList = data.dinner;
          } else {
            console.error('メニューリストの取得に失敗しました:', data.message);
          }
        },
        processCalendarData: function(data) {
          console.log('✅ processCalendarData開始:', data);
          
          if (data && data.success) {
            this.createMonthDates();
            
            // 配列の存在確認とデフォルト値設定
            this.breakfastReservations = Array.isArray(data.breakfast) ? data.breakfast : [];
            this.dinnerReservations = Array.isArray(data.dinner) ? data.dinner : [];
            
            console.log('予約データ設定完了:', {
              breakfastCount: this.breakfastReservations.length,
              dinnerCount: this.dinnerReservations.length
            });
            
            this.initializeMenuInputs();
            this.calendarLoaded = true;
            
            // カレンダーデータが読み込まれた後に適切な日付を選択
            this.setInitialSelectedDate();
          } else {
            const errorMessage = data && data.message ? data.message : 'データの取得に失敗しました';
            console.error('❌ データ処理エラー:', errorMessage);
            alert(errorMessage);
            this.calendarLoaded = false;
            
            // デフォルト値を設定
            this.breakfastReservations = [];
            this.dinnerReservations = [];
          }
          this.loading = false;
          this.calendarLoading = false;
        },
        initializeMenuInputs: function() {
          console.log('✅ initializeMenuInputs開始');
          
          this.breakfastMenuInputs = {};
          if (Array.isArray(this.breakfastReservations)) {
            for (const item of this.breakfastReservations) {
              if (item && item.calendarId) {
                this.$set(this.breakfastMenuInputs, item.calendarId, item.menuName !== "未設定" ? item.menuName : "");
              }
            }
          } else {
            console.warn('⚠️ breakfastReservations is not an array:', this.breakfastReservations);
          }
          
          this.dinnerMenuInputs = {};
          if (Array.isArray(this.dinnerReservations)) {
            for (const item of this.dinnerReservations) {
              if (item && item.calendarId) {
                this.$set(this.dinnerMenuInputs, item.calendarId, item.menuName !== "未設定" ? item.menuName : "");
              }
            }
          } else {
            console.warn('⚠️ dinnerReservations is not an array:', this.dinnerReservations);
          }
          
          console.log('メニュー入力初期化完了:', {
            breakfastInputs: Object.keys(this.breakfastMenuInputs).length,
            dinnerInputs: Object.keys(this.dinnerMenuInputs).length
          });
        },
        updateMenu: function(mealType, calendarId) {
          const menuInput = mealType === 'breakfast' ? this.breakfastMenuInputs[calendarId] : this.dinnerMenuInputs[calendarId];
          if (!menuInput || menuInput.trim() === '') {
            alert('メニューを入力してください');
            return;
          }
          
          this.menuUpdateLoading = true;
          google.script.run
            .withSuccessHandler(response => {
              this.handleMenuUpdateSuccess(response, mealType, calendarId, menuInput);
            })
            .withFailureHandler(this.handleError)
            .updateMenuForCalendar(calendarId, mealType, menuInput, this.currentYear, this.currentMonth);
        },
        handleMenuUpdateSuccess: function(response, mealType, calendarId, menuName) {
          if (response.success) {
            alert('メニューを更新しました');
            const targetReservations = mealType === 'breakfast' ? this.breakfastReservations : this.dinnerReservations;
            const targetMenuList = mealType === 'breakfast' ? this.breakfastMenuList : this.dinnerMenuList;
            const index = targetReservations.findIndex(item => item.calendarId == calendarId);
            if (index !== -1) {
              targetReservations[index].menuName = menuName;
              targetReservations[index].menuId = response.menuId;
            }
            if (response.isNewMenu && !targetMenuList.includes(menuName)) {
              targetMenuList.push(menuName);
              targetMenuList.sort();
            }
          } else {
            alert('メニューの更新に失敗しました: ' + response.message);
          }
          this.menuUpdateLoading = false;
        },
        createMonthDates: function() {
          const daysInMonth = new Date(this.currentYear, this.currentMonth, 0).getDate();
          const firstDayOfMonth = new Date(this.currentYear, this.currentMonth - 1, 1);
          this.offset = firstDayOfMonth.getDay();
          this.monthDates = [];
          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(this.currentYear, this.currentMonth - 1, day);
            this.monthDates.push(this.formatDate(date));
          }
        },
        formatDate: function(date) {
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, "0");
          const day = date.getDate().toString().padStart(2, "0");
          return `${year}-${month}-${day}`;
        },
        formatDateJapanese: function(date) {
          const month = date.getMonth() + 1;
          const day = date.getDate();
          return `${month}月${day}日`;
        },
        handleCalendarError: function(error) {
          console.error('カレンダーデータの取得中にエラーが発生しました:', error);
          this.loading = false;
          this.calendarLoading = false;
          alert('カレンダーデータの読み込み中にエラーが発生しました。');
        },
        handleError: function(error) {
          console.error('エラーが発生しました:', error);
          this.loading = false;
          this.calendarLoading = false;
          this.menuUpdateLoading = false;
          this.recruitmentToggleLoading = false;
          this.sheetOpenLoading = false;
          alert('処理中にエラーが発生しました。ページを更新してください。');
        },
        prevMonth: function() {
          if (this.currentMonth === 1) {
            this.currentYear--;
            this.currentMonth = 12;
          } else {
            this.currentMonth--;
          }
          // 月切り替え時は選択をクリア
          this.selectedDate = null;
          this.editBreakfastMenu = '';
          this.editDinnerMenu = '';
          this.editBreakfastCalorie = 0;
          this.editDinnerCalorie = 0;
          // Reset autocomplete states
          this.showBreakfastSuggestionsList = false;
          this.showDinnerSuggestionsList = false;
          this.breakfastSelectedIndex = -1;
          this.dinnerSelectedIndex = -1;
          this.loadCalendarData();
        },
        nextMonth: function() {
          if (this.currentMonth === 12) {
            this.currentYear++;
            this.currentMonth = 1;
          } else {
            this.currentMonth++;
          }
          // 月切り替え時は選択をクリア
          this.selectedDate = null;
          this.editBreakfastMenu = '';
          this.editDinnerMenu = '';
          this.editBreakfastCalorie = 0;
          this.editDinnerCalorie = 0;
          // Reset autocomplete states
          this.showBreakfastSuggestionsList = false;
          this.showDinnerSuggestionsList = false;
          this.breakfastSelectedIndex = -1;
          this.dinnerSelectedIndex = -1;
          this.loadCalendarData();
        },
        // --- ★ ここがスプレッドシートを開く処理 ---
        openMealSheet: function() {
          this.sheetOpenLoading = true;
          google.script.run
            .withSuccessHandler(response => {
              this.sheetOpenLoading = false;
              if (response.success) {
                window.open(response.url, '_blank');
              } else {
                alert('スプレッドシートの取得に失敗しました: ' + response.message);
              }
            })
            .withFailureHandler(error => {
              this.sheetOpenLoading = false;
              this.handleError(error);
            })
            .getMealSheetUrl();
        },
        // --- ここまで ---
        getBreakfastForDate: function(dateStr) {
          return this.breakfastReservations.find(item => item.date === dateStr);
        },
        getDinnerForDate: function(dateStr) {
          return this.dinnerReservations.find(item => item.date === dateStr);
        },
        getDayFromDate: function(dateStr) {
          return dateStr.split('-')[2].replace(/^0/, '');
        },
        isSaturday: function(dateStr) {
          return new Date(dateStr).getDay() === 6;
        },
        isSunday: function(dateStr) {
          return new Date(dateStr).getDay() === 0;
        },
        isToday: function(dateStr) {
          return dateStr === this.formatDate(new Date());
        },
        selectBreakfastMenu(calendarId) {
            // This is just to ensure reactivity, no specific action needed here
        },
        selectDinnerMenu(calendarId) {
            // Same as above
        },
        // 募集停止関連のメソッド
        isRecruitmentStopped: function(date, mealType) {
          return this.recruitmentStops[date] && this.recruitmentStops[date][mealType];
        },
        toggleRecruitmentStop: function(date, mealType) {
          this.recruitmentToggleLoading = true;
          google.script.run
            .withSuccessHandler(response => {
              this.recruitmentToggleLoading = false;
              if (response.success) {
                alert(response.message);
                this.fetchRecruitmentStops();
              } else {
                alert('操作に失敗しました: ' + response.message);
              }
            })
            .withFailureHandler(error => {
              this.recruitmentToggleLoading = false;
              this.handleError(error);
            })
            .toggleRecruitmentStop(date, mealType, this.currentYear, this.currentMonth);
        },
        // 新しいメニュー編集メソッド
        selectDate: function(date) {
          this.selectedDate = date;
          this.updateEditMenus(date);
        },
        closeMenuEdit: function() {
          this.selectedDate = null;
          this.editBreakfastMenu = '';
          this.editDinnerMenu = '';
          // Reset autocomplete states
          this.showBreakfastSuggestionsList = false;
          this.showDinnerSuggestionsList = false;
          this.breakfastSelectedIndex = -1;
          this.dinnerSelectedIndex = -1;
        },
        // Autocomplete functionality for breakfast menu
        onBreakfastMenuInput: function() {
          this.filterBreakfastMenus();
          this.showBreakfastSuggestionsList = true;
          this.breakfastSelectedIndex = -1;
        },
        filterBreakfastMenus: function() {
          if (!this.editBreakfastMenu || this.editBreakfastMenu.trim() === '') {
            this.filteredBreakfastMenus = this.breakfastMenuList.slice(0, 10); // Show first 10 when empty
          } else {
            const searchTerm = this.editBreakfastMenu.toLowerCase().trim();
            this.filteredBreakfastMenus = this.breakfastMenuList.filter(menu => 
              menu.name.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
          }
        },
        showBreakfastSuggestions: function() {
          // 現在のメニューが「未設定」の場合、入力フィールドをクリア
          const breakfast = this.getBreakfastForDate(this.selectedDate);
          if (breakfast && breakfast.menuName === '未設定') {
            this.editBreakfastMenu = '';
            this.editBreakfastCalorie = 0;
          }
          this.filterBreakfastMenus();
          this.showBreakfastSuggestionsList = true;
        },
        hideBreakfastSuggestions: function() {
          // Add small delay to allow selection
          setTimeout(() => {
            this.showBreakfastSuggestionsList = false;
            this.breakfastSelectedIndex = -1;
          }, 150);
        },
        selectBreakfastMenu: function(menu) {
          this.editBreakfastMenu = menu.name;
          this.editBreakfastCalorie = menu.calorie;
          this.showBreakfastSuggestionsList = false;
          this.breakfastSelectedIndex = -1;
        },
        onBreakfastKeydown: function(event) {
          if (!this.showBreakfastSuggestionsList || this.filteredBreakfastMenus.length === 0) {
            return;
          }
          
          switch (event.key) {
            case 'ArrowDown':
              event.preventDefault();
              this.breakfastSelectedIndex = Math.min(this.breakfastSelectedIndex + 1, this.filteredBreakfastMenus.length - 1);
              break;
            case 'ArrowUp':
              event.preventDefault();
              this.breakfastSelectedIndex = Math.max(this.breakfastSelectedIndex - 1, -1);
              break;
            case 'Enter':
              event.preventDefault();
              if (this.breakfastSelectedIndex >= 0) {
                this.selectBreakfastMenu(this.filteredBreakfastMenus[this.breakfastSelectedIndex]);
              }
              break;
            case 'Escape':
              this.showBreakfastSuggestionsList = false;
              this.breakfastSelectedIndex = -1;
              break;
          }
        },
        
        // Autocomplete functionality for dinner menu
        onDinnerMenuInput: function() {
          this.filterDinnerMenus();
          this.showDinnerSuggestionsList = true;
          this.dinnerSelectedIndex = -1;
        },
        filterDinnerMenus: function() {
          if (!this.editDinnerMenu || this.editDinnerMenu.trim() === '') {
            this.filteredDinnerMenus = this.dinnerMenuList.slice(0, 10); // Show first 10 when empty
          } else {
            const searchTerm = this.editDinnerMenu.toLowerCase().trim();
            this.filteredDinnerMenus = this.dinnerMenuList.filter(menu => 
              menu.name.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
          }
        },
        showDinnerSuggestions: function() {
          // 現在のメニューが「未設定」の場合、入力フィールドをクリア
          const dinner = this.getDinnerForDate(this.selectedDate);
          if (dinner && dinner.menuName === '未設定') {
            this.editDinnerMenu = '';
            this.editDinnerCalorie = 0;
          }
          this.filterDinnerMenus();
          this.showDinnerSuggestionsList = true;
        },
        hideDinnerSuggestions: function() {
          // Add small delay to allow selection
          setTimeout(() => {
            this.showDinnerSuggestionsList = false;
            this.dinnerSelectedIndex = -1;
          }, 150);
        },
        selectDinnerMenu: function(menu) {
          this.editDinnerMenu = menu.name;
          this.editDinnerCalorie = menu.calorie;
          this.showDinnerSuggestionsList = false;
          this.dinnerSelectedIndex = -1;
        },
        onDinnerKeydown: function(event) {
          if (!this.showDinnerSuggestionsList || this.filteredDinnerMenus.length === 0) {
            return;
          }
          
          switch (event.key) {
            case 'ArrowDown':
              event.preventDefault();
              this.dinnerSelectedIndex = Math.min(this.dinnerSelectedIndex + 1, this.filteredDinnerMenus.length - 1);
              break;
            case 'ArrowUp':
              event.preventDefault();
              this.dinnerSelectedIndex = Math.max(this.dinnerSelectedIndex - 1, -1);
              break;
            case 'Enter':
              event.preventDefault();
              if (this.dinnerSelectedIndex >= 0) {
                this.selectDinnerMenu(this.filteredDinnerMenus[this.dinnerSelectedIndex]);
              }
              break;
            case 'Escape':
              this.showDinnerSuggestionsList = false;
              this.dinnerSelectedIndex = -1;
              break;
          }
        },
        updateSelectedMenu: function(mealType) {
          const breakfast = this.getBreakfastForDate(this.selectedDate);
          const dinner = this.getDinnerForDate(this.selectedDate);
          
          let calendarId;
          let menuInput;
          let calorieInput;
          
          if (mealType === 'breakfast' && breakfast) {
            calendarId = breakfast.calendarId;
            menuInput = this.editBreakfastMenu;
            calorieInput = this.editBreakfastCalorie;
          } else if (mealType === 'dinner' && dinner) {
            calendarId = dinner.calendarId;
            menuInput = this.editDinnerMenu;
            calorieInput = this.editDinnerCalorie;
          }
          
          if (!calendarId || !menuInput || menuInput.trim() === '') {
            alert('メニューを入力してください');
            return;
          }
          
          this.menuUpdateLoading = true;
          google.script.run
            .withSuccessHandler(response => {
              this.handleSelectedMenuUpdateSuccess(response, mealType, calendarId, menuInput, calorieInput);
            })
            .withFailureHandler(this.handleError)
            .updateMenuForCalendar(calendarId, mealType, menuInput, calorieInput, this.currentYear, this.currentMonth);
        },
        handleSelectedMenuUpdateSuccess: function(response, mealType, calendarId, menuName, calorieValue) {
          if (response.success) {
            alert('メニューを更新しました');
            const targetReservations = mealType === 'breakfast' ? this.breakfastReservations : this.dinnerReservations;
            const targetMenuList = mealType === 'breakfast' ? this.breakfastMenuList : this.dinnerMenuList;
            const index = targetReservations.findIndex(item => item.calendarId == calendarId);
            if (index !== -1) {
              targetReservations[index].menuName = menuName;
              targetReservations[index].menuId = response.menuId;
              targetReservations[index].calorie = calorieValue || 0;
            }
            if (response.isNewMenu && !targetMenuList.some(m => m.name === menuName)) {
              targetMenuList.push({
                name: menuName,
                calorie: calorieValue || 0
              });
              targetMenuList.sort((a, b) => a.name.localeCompare(b.name));
            }
            // Reset autocomplete states
            if (mealType === 'breakfast') {
              this.showBreakfastSuggestionsList = false;
              this.breakfastSelectedIndex = -1;
            } else {
              this.showDinnerSuggestionsList = false;
              this.dinnerSelectedIndex = -1;
            }
          } else {
            alert('メニューの更新に失敗しました: ' + response.message);
          }
          this.menuUpdateLoading = false;
        },
        toggleSelectedRecruitmentStop: function(mealType) {
          if (!this.selectedDate) return;
          
          this.recruitmentToggleLoading = true;
          google.script.run
            .withSuccessHandler(response => {
              this.recruitmentToggleLoading = false;
              if (response.success) {
                alert(response.message);
                this.fetchRecruitmentStops();
              } else {
                alert('操作に失敗しました: ' + response.message);
              }
            })
            .withFailureHandler(error => {
              this.recruitmentToggleLoading = false;
              this.handleError(error);
            })
            .toggleRecruitmentStop(this.selectedDate, mealType, this.currentYear, this.currentMonth);
        },
        // 初期選択日付を設定するメソッド
        setInitialSelectedDate: function() {
          const today = this.formatDate(new Date());
          
          // 今日の日付が現在表示中の月に含まれている場合は今日を選択
          if (this.monthDates && this.monthDates.includes(today)) {
            this.selectedDate = today;
            this.updateEditMenus(today);
          } else {
            // 今日が現在の月に含まれていない場合は、その月の最初の日を選択
            if (this.monthDates && this.monthDates.length > 0) {
              this.selectedDate = this.monthDates[0];
              this.updateEditMenus(this.monthDates[0]);
            }
          }
        },
        // 選択された日付のメニュー情報を編集フィールドに更新
        updateEditMenus: function(date) {
          const breakfast = this.getBreakfastForDate(date);
          const dinner = this.getDinnerForDate(date);
          
          this.editBreakfastMenu = breakfast && breakfast.menuName !== '未設定' ? breakfast.menuName : '';
          this.editDinnerMenu = dinner && dinner.menuName !== '未設定' ? dinner.menuName : '';
          // Reset autocomplete states
          this.showBreakfastSuggestionsList = false;
          this.showDinnerSuggestionsList = false;
          this.breakfastSelectedIndex = -1;
          this.dinnerSelectedIndex = -1;
        },
      },
      mounted: function() {
        this.loadCalendarData();
      }
    });
  </script>
</body>
</html>